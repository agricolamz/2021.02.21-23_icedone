[["сбор-данных-из-интернета-rvest.html", "4 Сбор данных из интернета: rvest 4.1 Введение 4.2 Работа с пакетом rvest 4.3 Использование циклов 4.4 Обкачивание нескольких страниц", " 4 Сбор данных из интернета: rvest library(tidyverse) Достаточно часто данные не ходят упакованные в готовые файлы .csv или .json. Иногда данные лежат в открытом доступе на какой-нибудь странице в интернете. А иногда никто и не думал, что что-то станет данными: заголовки и тексты новостей, комментарии, твиты и т. п. В этом разделе мы обсудим основы извлечения данных из вебстраниц. 4.1 Введение Любая html-документ — это обычный xml файл, т. е. такой иерархически устроенный тип данных, где у каждого узла (кроме корневого) есть родительский узел и могут быть дочерние узлы и дополнительные атрибуты. Обычно самый верхний узел называется html, который имеет два дочерних узла head и body. Каждый html-документ является инструкцией для браузера, в которой говориться что и в каком порядке нужно отображать, но одновременно эта инструкция является кодом, который мы можем посмотреть. В большинстве браузеров это можно сделать при помощи горячих клавиш Ctrl+U, в Apple Safari — Cmd+Option+U. Кроме того есть режим разработчика, который позволяет делать много всего, в том числе наводить на какой-то объект в браузере и узнавать какой фрагмент кода ему соответствует (этот режим можно вызвать, нажав F12 или Ctrl+Shift+I, в Apple Safari вроде нет горячих клавиш и нужно вызывать как-то из меню). Большинство узлов html-документа состоят из тег узла, например, p значения узла, например, Жили-были три медведя. id (уникальные объекты в html-документе), class (неуникальные объекты в html-документе) и другием атрибуты узла Например: &lt;p class=&quot;story&quot; some_atribute = 42&gt;Жили-были три медведя.&lt;/p&gt; Некоторые html-документ не являются статическими и изменяются после того, как страница была открыта при помощи JavaScript’а. Это динамичность может быть скрытой, когда пользователь лишь видит, как открывается страница, а иногда может быть завязана на некоторые действия пользователя. Информацию со статических страниц собирать достаточно просто и для этого нам хватит пакета rvest. C динамическими сайтами все иногда несколько сложнее. Иногда на динамических страницах можно отследить источник данных, посмотрев вкладку Network в режиме разработчика (ведь откуда-то эти данные появляются в браузере, правда?). Иногда необходимо делать POST и GET запросы, хранить cookies, и т. п. — все это можно сделать при помощи пакета httr, а в самых сложных случаях (когда JavaScript JavaScript погоняет) поможет пакет RSelenium. html-тэгов очень много. Нам понадобятся: h1, h2, h3… – заголовки разного уровня p – абзац текста a – ссылка div – блок страницы (от слова division) Остальное смотрите, например, здесь. 4.2 Работа с пакетом rvest Пакет rvest позволяет скачивать страницы и потом их обрабатывать. Включим библиотеку: library(rvest) 4.2.1 Простой случай В качестве примера рассмотрим раздел популярное сайта &lt;ficbook.net&gt;: source &lt;- read_html(&quot;https://ficbook.net/popular&quot;) Объект source является списком, который содержит html-страницу. Давайте для начала выгрузим заголовок первого уровня. Функция html_nodes() позволяет вычленить исключительно узлы с каким-то тегом из всего xml-файла. source %&gt;% html_nodes(&quot;h1&quot;) {xml_nodeset (1)} [1] &lt;h1&gt;\\n Популярные фанфики и ориджиналы\\n &lt;/h1&gt; Как видно, функция вовзращает целый узел со всеми тегами. Давайте допустим, что мы хотем скачать все заголовки новостей, т. е. нам нужны значения всех узло h3. source %&gt;% html_nodes(&quot;h3&quot;) {xml_nodeset (51)} [1] &lt;h3&gt;\\n \\n ... [2] &lt;h3&gt;\\n \\n ... [3] &lt;h3&gt;\\n \\n ... [4] &lt;h3&gt;\\n \\n ... [5] &lt;h3&gt;\\n \\n ... [6] &lt;h3&gt;\\n \\n ... [7] &lt;h3&gt;\\n \\n ... [8] &lt;h3&gt;\\n \\n ... [9] &lt;h3&gt;\\n \\n ... [10] &lt;h3&gt;\\n \\n ... [11] &lt;h3&gt;\\n \\n ... [12] &lt;h3&gt;\\n \\n ... [13] &lt;h3&gt;\\n \\n ... [14] &lt;h3&gt;\\n \\n ... [15] &lt;h3&gt;\\n \\n ... [16] &lt;h3&gt;\\n \\n ... [17] &lt;h3&gt;\\n \\n ... [18] &lt;h3&gt;\\n \\n ... [19] &lt;h3&gt;\\n \\n ... [20] &lt;h3&gt;\\n \\n ... ... Ничего не видно. Это связано с тем, что на данном сайте в заголовки добавили много всего: Теперь если мы хотим обратиться к значениям этих узлов, мы можем использовать функцию html_text(): source %&gt;% html_nodes(&quot;h3&quot;) %&gt;% html_text() [1] &quot;\\n \\n \\n \\n \\n\\n Yellow\\n 41034&quot; [2] &quot;\\n \\n \\n \\n \\n\\n Сметана\\n 30382&quot; [3] &quot;\\n \\n \\n \\n \\n\\n Три месяца, ноль дней и ноль часов\\n 2494&quot; [4] &quot;\\n \\n \\n \\n \\n\\n Снежный принц для Владыки\\n 21492&quot; [5] &quot;\\n \\n \\n \\n \\n\\n Лисамайн\\n 26612&quot; [6] &quot;\\n \\n \\n \\n \\n\\n shadow moses \\n 1918&quot; [7] &quot;\\n \\n \\n \\n \\n\\n Дракобыль\\n 22403&quot; [8] &quot;\\n \\n \\n \\n \\n\\n Невинный для Ночного господина\\n 14327&quot; [9] &quot;\\n \\n \\n \\n \\n\\n Ban Crann\\n 17641&quot; [10] &quot;\\n \\n \\n \\n \\n\\n the union is our only strength\\n 1327&quot; [11] &quot;\\n \\n \\n \\n \\n\\n Вжик-вжик\\n 19581&quot; [12] &quot;\\n \\n \\n \\n \\n\\n Район спальный \\n 12573&quot; [13] &quot;\\n \\n \\n \\n \\n\\n feels like home\\n 23741&quot; [14] &quot;\\n \\n \\n \\n \\n\\n soon, he is going to be my lover\\n 1166&quot; [15] &quot;\\n \\n \\n \\n \\n\\n Волчье\\n 15882&quot; [16] &quot;\\n \\n \\n \\n \\n\\n Deadlock\\n 727055&quot; [17] &quot;\\n \\n \\n \\n \\n\\n Не провоцируй меня, Слоник!\\n 11335&quot; [18] &quot;\\n \\n \\n \\n \\n\\n злой \\n 1114&quot; [19] &quot;\\n \\n \\n \\n \\n\\n Молочайный Ангел\\n 18351&quot; [20] &quot;\\n \\n \\n \\n \\n\\n fuck me, bestie\\n 1169&quot; [21] &quot;\\n \\n \\n \\n \\n\\n Волчий Рай\\n 13931&quot; [22] &quot;\\n \\n \\n \\n \\n\\n Миша и опер Медведев\\n 143313&quot; [23] &quot;\\n \\n \\n \\n \\n\\n Jamais vu\\n 326014&quot; [24] &quot;\\n \\n \\n \\n \\n\\n С любовью, розовый\\n 11333&quot; [25] &quot;\\n \\n \\n \\n \\n\\n Принц на белом ковре \\n 7902&quot; [26] &quot;\\n \\n \\n \\n \\n\\n at the end of everything\\n 698&quot; [27] &quot;\\n \\n \\n \\n \\n\\n Молодой Мороз\\n 7083&quot; [28] &quot;\\n \\n \\n \\n \\n\\n Я больше не облажаюсь, старлей...\\n 12023&quot; [29] &quot;\\n \\n \\n \\n \\n\\n Лесная ягода \\n 2110&quot; [30] &quot;\\n \\n \\n \\n \\n\\n Теория большого срыва\\n 836&quot; [31] &quot;\\n \\n \\n \\n \\n\\n Знание — сила!\\n 431221&quot; [32] &quot;\\n \\n \\n \\n \\n\\n Кабинет 69.\\n 2816&quot; [33] &quot;\\n \\n \\n \\n \\n\\n К вопросу об отношениях\\n 21641&quot; [34] &quot;\\n \\n \\n \\n \\n\\n Из пункта А в пункт Б\\n 5951&quot; [35] &quot;\\n \\n \\n \\n \\n\\n Приятный вечер \\n 590&quot; [36] &quot;\\n \\n \\n \\n \\n\\n Алаймент\\n 458966&quot; [37] &quot;\\n \\n \\n \\n \\n\\n Последний день первого летнего месяца \\n 5571&quot; [38] &quot;\\n \\n \\n \\n \\n\\n Хочу детей от друга\\n 19201&quot; [39] &quot;\\n \\n \\n \\n \\n\\n Светлячок\\n 13681&quot; [40] &quot;\\n \\n \\n \\n \\n\\n В лесу, где мерцают светлячки.\\n 523&quot; [41] &quot;\\n \\n \\n \\n \\n\\n Парень из квартиры напротив \\n 379910&quot; [42] &quot;\\n \\n \\n \\n \\n\\n Последнее, чем стоит заниматься капитану Ордо Фавониус\\n 523&quot; [43] &quot;\\n \\n \\n \\n \\n\\n Тяжела и неказиста жизнь простого героиста\\n 526&quot; [44] &quot;\\n \\n \\n \\n \\n\\n Необычные \\n 11688&quot; [45] &quot;\\n \\n \\n \\n \\n\\n remember not to get too close to stars\\n 490&quot; [46] &quot;\\n \\n \\n \\n \\n\\n Не зная, как, когда или откуда\\n 856&quot; [47] &quot;\\n \\n \\n \\n \\n\\n Но... я же Питер Паркер!\\n 628014&quot; [48] &quot;\\n \\n \\n \\n \\n\\n Привет, Джимми!\\n 9052&quot; [49] &quot;\\n \\n \\n \\n \\n\\n Выбор Тристана\\n 24426&quot; [50] &quot;\\n \\n \\n \\n \\n\\n Бывшие\\n 23762&quot; [51] &quot;Войдите в аккаунт&quot; Стоит почистить: source %&gt;% html_nodes(&quot;h3&quot;) %&gt;% html_text() %&gt;% str_replace_all(&quot; {1,}&quot;, &quot; &quot;) [1] &quot;\\n \\n \\n \\n \\n\\n Yellow\\n 41034&quot; [2] &quot;\\n \\n \\n \\n \\n\\n Сметана\\n 30382&quot; [3] &quot;\\n \\n \\n \\n \\n\\n Три месяца, ноль дней и ноль часов\\n 2494&quot; [4] &quot;\\n \\n \\n \\n \\n\\n Снежный принц для Владыки\\n 21492&quot; [5] &quot;\\n \\n \\n \\n \\n\\n Лисамайн\\n 26612&quot; [6] &quot;\\n \\n \\n \\n \\n\\n shadow moses \\n 1918&quot; [7] &quot;\\n \\n \\n \\n \\n\\n Дракобыль\\n 22403&quot; [8] &quot;\\n \\n \\n \\n \\n\\n Невинный для Ночного господина\\n 14327&quot; [9] &quot;\\n \\n \\n \\n \\n\\n Ban Crann\\n 17641&quot; [10] &quot;\\n \\n \\n \\n \\n\\n the union is our only strength\\n 1327&quot; [11] &quot;\\n \\n \\n \\n \\n\\n Вжик-вжик\\n 19581&quot; [12] &quot;\\n \\n \\n \\n \\n\\n Район спальный \\n 12573&quot; [13] &quot;\\n \\n \\n \\n \\n\\n feels like home\\n 23741&quot; [14] &quot;\\n \\n \\n \\n \\n\\n soon, he is going to be my lover\\n 1166&quot; [15] &quot;\\n \\n \\n \\n \\n\\n Волчье\\n 15882&quot; [16] &quot;\\n \\n \\n \\n \\n\\n Deadlock\\n 727055&quot; [17] &quot;\\n \\n \\n \\n \\n\\n Не провоцируй меня, Слоник!\\n 11335&quot; [18] &quot;\\n \\n \\n \\n \\n\\n злой \\n 1114&quot; [19] &quot;\\n \\n \\n \\n \\n\\n Молочайный Ангел\\n 18351&quot; [20] &quot;\\n \\n \\n \\n \\n\\n fuck me, bestie\\n 1169&quot; [21] &quot;\\n \\n \\n \\n \\n\\n Волчий Рай\\n 13931&quot; [22] &quot;\\n \\n \\n \\n \\n\\n Миша и опер Медведев\\n 143313&quot; [23] &quot;\\n \\n \\n \\n \\n\\n Jamais vu\\n 326014&quot; [24] &quot;\\n \\n \\n \\n \\n\\n С любовью, розовый\\n 11333&quot; [25] &quot;\\n \\n \\n \\n \\n\\n Принц на белом ковре \\n 7902&quot; [26] &quot;\\n \\n \\n \\n \\n\\n at the end of everything\\n 698&quot; [27] &quot;\\n \\n \\n \\n \\n\\n Молодой Мороз\\n 7083&quot; [28] &quot;\\n \\n \\n \\n \\n\\n Я больше не облажаюсь, старлей...\\n 12023&quot; [29] &quot;\\n \\n \\n \\n \\n\\n Лесная ягода \\n 2110&quot; [30] &quot;\\n \\n \\n \\n \\n\\n Теория большого срыва\\n 836&quot; [31] &quot;\\n \\n \\n \\n \\n\\n Знание — сила!\\n 431221&quot; [32] &quot;\\n \\n \\n \\n \\n\\n Кабинет 69.\\n 2816&quot; [33] &quot;\\n \\n \\n \\n \\n\\n К вопросу об отношениях\\n 21641&quot; [34] &quot;\\n \\n \\n \\n \\n\\n Из пункта А в пункт Б\\n 5951&quot; [35] &quot;\\n \\n \\n \\n \\n\\n Приятный вечер \\n 590&quot; [36] &quot;\\n \\n \\n \\n \\n\\n Алаймент\\n 458966&quot; [37] &quot;\\n \\n \\n \\n \\n\\n Последний день первого летнего месяца \\n 5571&quot; [38] &quot;\\n \\n \\n \\n \\n\\n Хочу детей от друга\\n 19201&quot; [39] &quot;\\n \\n \\n \\n \\n\\n Светлячок\\n 13681&quot; [40] &quot;\\n \\n \\n \\n \\n\\n В лесу, где мерцают светлячки.\\n 523&quot; [41] &quot;\\n \\n \\n \\n \\n\\n Парень из квартиры напротив \\n 379910&quot; [42] &quot;\\n \\n \\n \\n \\n\\n Последнее, чем стоит заниматься капитану Ордо Фавониус\\n 523&quot; [43] &quot;\\n \\n \\n \\n \\n\\n Тяжела и неказиста жизнь простого героиста\\n 526&quot; [44] &quot;\\n \\n \\n \\n \\n\\n Необычные \\n 11688&quot; [45] &quot;\\n \\n \\n \\n \\n\\n remember not to get too close to stars\\n 490&quot; [46] &quot;\\n \\n \\n \\n \\n\\n Не зная, как, когда или откуда\\n 856&quot; [47] &quot;\\n \\n \\n \\n \\n\\n Но... я же Питер Паркер!\\n 628014&quot; [48] &quot;\\n \\n \\n \\n \\n\\n Привет, Джимми!\\n 9052&quot; [49] &quot;\\n \\n \\n \\n \\n\\n Выбор Тристана\\n 24426&quot; [50] &quot;\\n \\n \\n \\n \\n\\n Бывшие\\n 23762&quot; [51] &quot;Войдите в аккаунт&quot; Ага теперь видно, что к нам в заголовки затесалось предложение войти в аккаунт. Пока просто удалим. source %&gt;% html_nodes(&quot;h3&quot;) %&gt;% html_text() %&gt;% str_replace_all(&quot; {1,}&quot;, &quot; &quot;) %&gt;% str_remove_all(&quot;\\n&quot;) %&gt;% # удалим все \\n str_remove_all(&quot;^ {1,}&quot;) # удалим все пробелы в начале строки [1] &quot;Yellow 41034&quot; [2] &quot;Сметана 30382&quot; [3] &quot;Три месяца, ноль дней и ноль часов 2494&quot; [4] &quot;Снежный принц для Владыки 21492&quot; [5] &quot;Лисамайн 26612&quot; [6] &quot;shadow moses 1918&quot; [7] &quot;Дракобыль 22403&quot; [8] &quot;Невинный для Ночного господина 14327&quot; [9] &quot;Ban Crann 17641&quot; [10] &quot;the union is our only strength 1327&quot; [11] &quot;Вжик-вжик 19581&quot; [12] &quot;Район спальный 12573&quot; [13] &quot;feels like home 23741&quot; [14] &quot;soon, he is going to be my lover 1166&quot; [15] &quot;Волчье 15882&quot; [16] &quot;Deadlock 727055&quot; [17] &quot;Не провоцируй меня, Слоник! 11335&quot; [18] &quot;злой 1114&quot; [19] &quot;Молочайный Ангел 18351&quot; [20] &quot;fuck me, bestie 1169&quot; [21] &quot;Волчий Рай 13931&quot; [22] &quot;Миша и опер Медведев 143313&quot; [23] &quot;Jamais vu 326014&quot; [24] &quot;С любовью, розовый 11333&quot; [25] &quot;Принц на белом ковре 7902&quot; [26] &quot;at the end of everything 698&quot; [27] &quot;Молодой Мороз 7083&quot; [28] &quot;Я больше не облажаюсь, старлей... 12023&quot; [29] &quot;Лесная ягода 2110&quot; [30] &quot;Теория большого срыва 836&quot; [31] &quot;Знание — сила! 431221&quot; [32] &quot;Кабинет 69. 2816&quot; [33] &quot;К вопросу об отношениях 21641&quot; [34] &quot;Из пункта А в пункт Б 5951&quot; [35] &quot;Приятный вечер 590&quot; [36] &quot;Алаймент 458966&quot; [37] &quot;Последний день первого летнего месяца 5571&quot; [38] &quot;Хочу детей от друга 19201&quot; [39] &quot;Светлячок 13681&quot; [40] &quot;В лесу, где мерцают светлячки. 523&quot; [41] &quot;Парень из квартиры напротив 379910&quot; [42] &quot;Последнее, чем стоит заниматься капитану Ордо Фавониус 523&quot; [43] &quot;Тяжела и неказиста жизнь простого героиста 526&quot; [44] &quot;Необычные 11688&quot; [45] &quot;remember not to get too close to stars 490&quot; [46] &quot;Не зная, как, когда или откуда 856&quot; [47] &quot;Но... я же Питер Паркер! 628014&quot; [48] &quot;Привет, Джимми! 9052&quot; [49] &quot;Выбор Тристана 24426&quot; [50] &quot;Бывшие 23762&quot; [51] &quot;Войдите в аккаунт&quot; Теперь попробуем сделать таблицу и уберем цифры в конце: source %&gt;% html_nodes(&quot;h3&quot;) %&gt;% html_text() %&gt;% str_replace_all(&quot; {1,}&quot;, &quot; &quot;) %&gt;% str_remove_all(&quot;\\n&quot;) %&gt;% str_remove_all(&quot;^ {1,}&quot;) %&gt;% enframe() %&gt;% # превратим в таблицу slice(-n()) %&gt;% # удалим последнюю строчку mutate(numbers = str_extract(value, &quot;\\\\d*$&quot;), # выделим код value = str_remove(value, str_c(&quot; {1,}&quot;, numbers))) %&gt;% # удалим код и пробел select(-numbers) -&gt; # удалим столбец pop_fan_fiction pop_fan_fiction Каждый заголовок содержит ссылку на страницу фанфика, как бы ее добыть? Ссылка на самом деле в теге , так что теперь нам нужны такие &lt;a&gt;, которые находятся внутри &lt;h3&gt;: source %&gt;% html_nodes(&quot;h3 a&quot;) {xml_nodeset (50)} [1] &lt;a href=&quot;/readfic/10429398&quot; class=&quot;visit-link&quot;&gt;Yellow&lt;/a&gt; [2] &lt;a href=&quot;/readfic/10357485&quot; class=&quot;visit-link&quot;&gt;Сметана&lt;/a&gt; [3] &lt;a href=&quot;/readfic/10421614&quot; class=&quot;visit-link&quot;&gt;Три месяца, ноль дней и н ... [4] &lt;a href=&quot;/readfic/10395350&quot; class=&quot;visit-link&quot;&gt;Снежный принц для Владыки ... [5] &lt;a href=&quot;/readfic/10019420&quot; class=&quot;visit-link&quot;&gt;Лисамайн&lt;/a&gt; [6] &lt;a href=&quot;/readfic/10406612&quot; class=&quot;visit-link&quot;&gt;shadow moses &lt;/a&gt; [7] &lt;a href=&quot;/readfic/10121328&quot; class=&quot;visit-link&quot;&gt;Дракобыль&lt;/a&gt; [8] &lt;a href=&quot;/readfic/10420671&quot; class=&quot;visit-link&quot;&gt;Невинный для Ночного госп ... [9] &lt;a href=&quot;/readfic/10033794&quot; class=&quot;visit-link&quot;&gt;Ban Crann&lt;/a&gt; [10] &lt;a href=&quot;/readfic/10431022&quot; class=&quot;visit-link&quot;&gt;the union is our only str ... [11] &lt;a href=&quot;/readfic/10019753&quot; class=&quot;visit-link&quot;&gt;Вжик-вжик&lt;/a&gt; [12] &lt;a href=&quot;/readfic/10411907&quot; class=&quot;visit-link&quot;&gt;Район спальный &lt;/a&gt; [13] &lt;a href=&quot;/readfic/10408684&quot; class=&quot;visit-link&quot;&gt;feels like home&lt;/a&gt; [14] &lt;a href=&quot;/readfic/9570998&quot; class=&quot;visit-link&quot;&gt;soon, he is going to be my ... [15] &lt;a href=&quot;/readfic/10037569&quot; class=&quot;visit-link&quot;&gt;Волчье&lt;/a&gt; [16] &lt;a href=&quot;/readfic/9812943&quot; class=&quot;visit-link&quot;&gt;Deadlock&lt;/a&gt; [17] &lt;a href=&quot;/readfic/10442863&quot; class=&quot;visit-link&quot;&gt;Не провоцируй меня, Слони ... [18] &lt;a href=&quot;/readfic/10444901&quot; class=&quot;visit-link&quot;&gt;злой &lt;/a&gt; [19] &lt;a href=&quot;/readfic/10110697&quot; class=&quot;visit-link&quot;&gt;Молочайный Ангел&lt;/a&gt; [20] &lt;a href=&quot;/readfic/10388478&quot; class=&quot;visit-link&quot;&gt;fuck me, bestie&lt;/a&gt; ... Так как ссылка находиться не в тексте, а в атрибуте нужна функция html_attr(): source %&gt;% html_nodes(&quot;h3 a&quot;) %&gt;% html_attr(&quot;href&quot;) [1] &quot;/readfic/10429398&quot; &quot;/readfic/10357485&quot; &quot;/readfic/10421614&quot; [4] &quot;/readfic/10395350&quot; &quot;/readfic/10019420&quot; &quot;/readfic/10406612&quot; [7] &quot;/readfic/10121328&quot; &quot;/readfic/10420671&quot; &quot;/readfic/10033794&quot; [10] &quot;/readfic/10431022&quot; &quot;/readfic/10019753&quot; &quot;/readfic/10411907&quot; [13] &quot;/readfic/10408684&quot; &quot;/readfic/9570998&quot; &quot;/readfic/10037569&quot; [16] &quot;/readfic/9812943&quot; &quot;/readfic/10442863&quot; &quot;/readfic/10444901&quot; [19] &quot;/readfic/10110697&quot; &quot;/readfic/10388478&quot; &quot;/readfic/10114627&quot; [22] &quot;/readfic/10416997&quot; &quot;/readfic/10395456&quot; &quot;/readfic/10402262&quot; [25] &quot;/readfic/10381686&quot; &quot;/readfic/10432311&quot; &quot;/readfic/10034120&quot; [28] &quot;/readfic/10402435&quot; &quot;/readfic/9773287&quot; &quot;/readfic/10411105&quot; [31] &quot;/readfic/10371922&quot; &quot;/readfic/10309689&quot; &quot;/readfic/10415930&quot; [34] &quot;/readfic/10038401&quot; &quot;/readfic/10434460&quot; &quot;/readfic/10112253&quot; [37] &quot;/readfic/10428900&quot; &quot;/readfic/10379341&quot; &quot;/readfic/10371908&quot; [40] &quot;/readfic/10431516&quot; &quot;/readfic/9291104&quot; &quot;/readfic/10402989&quot; [43] &quot;/readfic/10433749&quot; &quot;/readfic/8160132&quot; &quot;/readfic/10440072&quot; [46] &quot;/readfic/10399219&quot; &quot;/readfic/7861843&quot; &quot;/readfic/10161264&quot; [49] &quot;/readfic/10329650&quot; &quot;/readfic/9178422&quot; Теперь мы можем сохранить это в переменную нашей таблицы pop_fan_fiction: source %&gt;% html_nodes(&quot;h3 a&quot;) %&gt;% html_attr(&quot;href&quot;) -&gt; pop_fan_fiction$link pop_fan_fiction Теперь, если мы соединим кусочек в графе link и https://ficbook.net, то мы получим ссылку на текст/оглавления фанфика. Добавьте к таблице столбец с количеством лайков. Попробуем обкачать авторов и ссылки на их страницы и добавить их к таблице. Если мы присмотримся, то авторы находятся в теге &lt;div&gt;. Однако это очень популярный тэг, и в нем может быть все, что угодно, так что добавим еще тегов, чтобы указать путь точнее: [1] &quot;Канда Лотос&quot; &quot;Канда Лотос&quot; [3] &quot;Франк пишет&quot; &quot;chate&quot; [5] &quot;Канда Лотос&quot; &quot;magnus bane&quot; [7] &quot;Канда Лотос&quot; &quot;Это Хорошо&quot; [9] &quot;Канда Лотос&quot; &quot;Чайка_Лу&quot; [11] &quot;Канда Лотос&quot; &quot;Deus Rex&quot; [13] &quot;international playgirl&quot; &quot;Чайка_Лу&quot; [15] &quot;Канда Лотос&quot; &quot;rikookie&quot; [17] &quot;Violetblackish&quot; &quot;советница&quot; [19] &quot;Канда Лотос&quot; &quot;Eva_Grey&quot; [21] &quot;Канда Лотос&quot; &quot;YKET&quot; [23] &quot;rikookie&quot; &quot;magnus bane&quot; [25] &quot;SGI&quot; &quot;Чайка_Лу&quot; [27] &quot;YKET&quot; &quot;Shifer dark&quot; [29] &quot;minimoninam&quot; &quot;Мистер_Крот&quot; [31] &quot;Aurit&quot; &quot;Anna Moss&quot; [33] &quot;лунный мечтатель полтергейста&quot; &quot;Violetblackish&quot; [35] &quot;Что то&quot; &quot;Rakot&quot; [37] &quot;i n s t a b i l i t a t e m&quot; &quot;SugarSyrup&quot; [39] &quot;Pak Yeon Hee&quot; &quot;Нана Юнминовна&quot; [41] &quot;Bunny Kam&quot; &quot;Лиэрт&quot; [43] &quot;aksiomazweifel&quot; &quot;Olesya Fox&quot; [45] &quot;Чайка_Лу&quot; &quot;Vi Ewaz&quot; [47] &quot;sarahyyy&quot; &quot;Drizzt&quot; [49] &quot;Аргус Филченков&quot; &quot;голубая радуга&quot; [51] &quot;younghosie&quot; Все хорошо, но получилось 52 строчки, а в нашем pop_fan_fiction лишь 50 строчек. Это связано с тем, что у некоторых фанфиков несколько авторов. К счастью это можно “вылечить” посмотрев на ссылки: source %&gt;% html_nodes(&quot;div span a&quot;) %&gt;% html_attr(&quot;href&quot;) -&gt; author_links author_links [1] &quot;/authors/1819996&quot; [2] &quot;/authors/1819996&quot; [3] &quot;/authors/4371126&quot; [4] &quot;/authors/45010&quot; [5] &quot;/authors/1819996&quot; [6] &quot;/authors/211970&quot; [7] &quot;/authors/1819996&quot; [8] &quot;/authors/1188188&quot; [9] &quot;/authors/1819996&quot; [10] &quot;/authors/923348&quot; [11] &quot;/authors/1819996&quot; [12] &quot;/authors/3601159&quot; [13] &quot;/authors/2551368&quot; [14] &quot;/authors/923348&quot; [15] &quot;/authors/1819996&quot; [16] &quot;/authors/153034&quot; [17] &quot;/authors/2486714&quot; [18] &quot;/authors/782676&quot; [19] &quot;/authors/1819996&quot; [20] &quot;/authors/1753188&quot; [21] &quot;/authors/1819996&quot; [22] &quot;/authors/3664744&quot; [23] &quot;/authors/153034&quot; [24] &quot;/authors/211970&quot; [25] &quot;/authors/3043458&quot; [26] &quot;/authors/923348&quot; [27] &quot;/authors/3664744&quot; [28] &quot;/authors/216926&quot; [29] &quot;/authors/4262993&quot; [30] &quot;/authors/4452996&quot; [31] &quot;/authors/4888014&quot; [32] &quot;/authors/2367076&quot; [33] &quot;/authors/125758&quot; [34] &quot;/authors/2486714&quot; [35] &quot;/authors/1609555&quot; [36] &quot;/authors/407214&quot; [37] &quot;/authors/3940941&quot; [38] &quot;/authors/4300578&quot; [39] &quot;/authors/2353948&quot; [40] &quot;/authors/54483&quot; [41] &quot;/authors/838868&quot; [42] &quot;/authors/184570&quot; [43] &quot;/authors/117765&quot; [44] &quot;/authors/2667581&quot; [45] &quot;/authors/923348&quot; [46] &quot;/authors/1476905&quot; [47] &quot;/translations/by_author?author=sarahyyy&quot; [48] &quot;/authors/1541298&quot; [49] &quot;/authors/3093607&quot; [50] &quot;/authors/1151836&quot; [51] &quot;/authors/3702102&quot; Как видно, второй автор возникает, в случаях с переводом, так что можно их отфильтровать: tibble(authors, author_links) %&gt;% filter(!str_detect(author_links, &quot;translation&quot;)) %&gt;% bind_cols(pop_fan_fiction) -&gt; pop_fan_fiction glimpse(pop_fan_fiction) Rows: 50 Columns: 5 $ authors &lt;chr&gt; &quot;Канда Лотос&quot;, &quot;Канда Лотос&quot;, &quot;Франк пишет&quot;, &quot;chate&quot;, &quot;К… $ author_links &lt;chr&gt; &quot;/authors/1819996&quot;, &quot;/authors/1819996&quot;, &quot;/authors/437112… $ name &lt;int&gt; 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 16, 1… $ value &lt;chr&gt; &quot;Yellow&quot;, &quot;Сметана&quot;, &quot;Три месяца, ноль дней и ноль часов… $ link &lt;chr&gt; &quot;/readfic/10429398&quot;, &quot;/readfic/10357485&quot;, &quot;/readfic/1042… 4.3 Использование циклов Давайте попробуем скачать пэйринг. Наш старый способ посмотреть путь, не пройдет, туда попадает много мусора: source %&gt;% html_nodes(&quot;dl a&quot;) %&gt;% html_text() %&gt;% head() [1] &quot;Ориджиналы&quot; &quot;Амур/Ким&quot; &quot;2000-е годы&quot; &quot;Hurt/Comfort&quot; &quot;Буллинг&quot; [6] &quot;Взросление&quot; Во-первых, так как к одному фанфику есть много меток, нужно сохранить как-то группировку по фанфику. Для этого я запущу функцию map() из пакета purr, но если вам комфортнее использовать lapply(), то можно один заменить на другой. Ну и я понимаю, что не все могут быть в восторге от цикла в пайпе, конечно, это можно делать и по-другому. source %&gt;% html_nodes(&quot;article&quot;) %&gt;% map(function(x){ x %&gt;% html_nodes(&quot;dl a&quot;) %&gt;% html_text() }) -&gt; all_meta head(all_meta, n = 3) [[1]] [1] &quot;Ориджиналы&quot; &quot;Амур/Ким&quot; [3] &quot;2000-е годы&quot; &quot;Hurt/Comfort&quot; [5] &quot;Буллинг&quot; &quot;Взросление&quot; [7] &quot;Забота / Поддержка&quot; &quot;Мечты&quot; [9] &quot;Неловкость&quot; &quot;От друзей к возлюбленным&quot; [11] &quot;Первый поцелуй&quot; &quot;Первый раз&quot; [13] &quot;Переходный возраст&quot; &quot;Повседневность&quot; [15] &quot;Подростки&quot; &quot;Подростковая влюбленность&quot; [17] &quot;Преодоление комплексов&quot; &quot;Признания в любви&quot; [19] &quot;Прогулки&quot; &quot;Развитие отношений&quot; [21] &quot;Разговоры&quot; &quot;Романтика&quot; [23] &quot;Россия&quot; &quot;Сентиментальность&quot; [25] &quot;Сновидения&quot; &quot;Соблазнение / Ухаживания&quot; [27] &quot;Учебные заведения&quot; &quot;Флафф&quot; [29] &quot;Школьный роман&quot; [[2]] [1] &quot;Ориджиналы&quot; &quot;Чомор, Сметана, собаки, люди&quot; [3] &quot;Hurt/Comfort&quot; &quot;Возвращение&quot; [5] &quot;Выбор&quot; &quot;Вымышленные существа&quot; [7] &quot;Деревни&quot; &quot;Дикие животные&quot; [9] &quot;Домашние животные&quot; &quot;Древняя Русь&quot; [11] &quot;Дружба&quot; &quot;Духи природы&quot; [13] &quot;Жертвы обстоятельств&quot; &quot;Жестокое обращение с животными&quot; [15] &quot;Запахи&quot; &quot;Леса&quot; [17] &quot;Люди&quot; &quot;Магия&quot; [19] &quot;Моральные дилеммы&quot; &quot;Обретенные семьи&quot; [21] &quot;Охотники&quot; &quot;Побег из дома&quot; [23] &quot;Покровительство&quot; &quot;Покушение на жизнь&quot; [25] &quot;Приключения&quot; &quot;Принуждение&quot; [27] &quot;Разумные животные&quot; &quot;Самоопределение / Самопознание&quot; [29] &quot;Свобода&quot; &quot;Сказка&quot; [31] &quot;Смена сущности&quot; &quot;Тайна происхождения&quot; [33] &quot;Тайная сущность&quot; &quot;Фэнтези&quot; [35] &quot;Шейпшифтеры&quot; &quot;Элементы ангста&quot; [37] &quot;Элементы драмы&quot; &quot;Этническое фэнтези&quot; [[3]] [1] &quot;Bangtan Boys (BTS)&quot; &quot;Пак Чимин/Мин Юнги&quot; &quot;альфа!Пак Чимин&quot; [4] &quot;альфа!Мин Юнги&quot; &quot;Запахи&quot; &quot;Омегаверс&quot; [7] &quot;Омегаверс: Альфа/Альфа&quot; &quot;Течка / Гон&quot; Теперь мы получили то, что нужно, но он возвращает все метки. К сожалению создатели сайта не очень позаботились о том, чтобы упростить нам жизнь, поэтому мы воспользуемся трюком, которым мы пользовались раньше и скачаем еще и ссылки. source %&gt;% html_nodes(&quot;article&quot;) %&gt;% map(function(x){ x %&gt;% html_nodes(&quot;dl a&quot;) %&gt;% html_attr(&quot;href&quot;) }) -&gt; all_meta_links head(all_meta_links, n = 3) [[1]] [1] &quot;/fanfiction/no_fandom/originals&quot; [2] &quot;/pairings/%D0%90%D0%BC%D1%83%D1%80/%D0%9A%D0%B8%D0%BC&quot; [3] &quot;/tags/590&quot; [4] &quot;/tags/1682&quot; [5] &quot;/tags/436&quot; [6] &quot;/tags/909&quot; [7] &quot;/tags/1302&quot; [8] &quot;/tags/993&quot; [9] &quot;/tags/2459&quot; [10] &quot;/tags/344&quot; [11] &quot;/tags/2790&quot; [12] &quot;/tags/1292&quot; [13] &quot;/tags/1297&quot; [14] &quot;/tags/1677&quot; [15] &quot;/tags/218&quot; [16] &quot;/tags/581&quot; [17] &quot;/tags/588&quot; [18] &quot;/tags/1049&quot; [19] &quot;/tags/2462&quot; [20] &quot;/tags/1404&quot; [21] &quot;/tags/1401&quot; [22] &quot;/tags/1664&quot; [23] &quot;/tags/701&quot; [24] &quot;/tags/2567&quot; [25] &quot;/tags/490&quot; [26] &quot;/tags/616&quot; [27] &quot;/tags/1694&quot; [28] &quot;/tags/1667&quot; [29] &quot;/tags/2440&quot; [[2]] [1] &quot;/fanfiction/no_fandom/originals&quot; [2] &quot;/pairings/%D0%A7%D0%BE%D0%BC%D0%BE%D1%80,%20%D0%A1%D0%BC%D0%B5%D1%82%D0%B0%D0%BD%D0%B0,%20%D1%81%D0%BE%D0%B1%D0%B0%D0%BA%D0%B8,%20%D0%BB%D1%8E%D0%B4%D0%B8&quot; [3] &quot;/tags/1682&quot; [4] &quot;/tags/1522&quot; [5] &quot;/tags/2808&quot; [6] &quot;/tags/1685&quot; [7] &quot;/tags/364&quot; [8] &quot;/tags/622&quot; [9] &quot;/tags/517&quot; [10] &quot;/tags/466&quot; [11] &quot;/tags/1701&quot; [12] &quot;/tags/503&quot; [13] &quot;/tags/1475&quot; [14] &quot;/tags/722&quot; [15] &quot;/tags/1385&quot; [16] &quot;/tags/703&quot; [17] &quot;/tags/1538&quot; [18] &quot;/tags/1419&quot; [19] &quot;/tags/959&quot; [20] &quot;/tags/601&quot; [21] &quot;/tags/2036&quot; [22] &quot;/tags/2309&quot; [23] &quot;/tags/2223&quot; [24] &quot;/tags/1057&quot; [25] &quot;/tags/21&quot; [26] &quot;/tags/1323&quot; [27] &quot;/tags/895&quot; [28] &quot;/tags/1278&quot; [29] &quot;/tags/2166&quot; [30] &quot;/tags/288&quot; [31] &quot;/tags/1707&quot; [32] &quot;/tags/662&quot; [33] &quot;/tags/1512&quot; [34] &quot;/tags/1669&quot; [35] &quot;/tags/29&quot; [36] &quot;/tags/2696&quot; [37] &quot;/tags/2697&quot; [38] &quot;/tags/667&quot; [[3]] [1] &quot;/fanfiction/rpf/bangtan&quot; [2] &quot;/pairings/%D0%9F%D0%B0%D0%BA%20%D0%A7%D0%B8%D0%BC%D0%B8%D0%BD---%D0%9C%D0%B8%D0%BD%20%D0%AE%D0%BD%D0%B3%D0%B8&quot; [3] &quot;/pairings/%D0%B0%D0%BB%D1%8C%D1%84%D0%B0!%D0%9F%D0%B0%D0%BA%20%D0%A7%D0%B8%D0%BC%D0%B8%D0%BD&quot; [4] &quot;/pairings/%D0%B0%D0%BB%D1%8C%D1%84%D0%B0!%D0%9C%D0%B8%D0%BD%20%D0%AE%D0%BD%D0%B3%D0%B8&quot; [5] &quot;/tags/1385&quot; [6] &quot;/tags/1693&quot; [7] &quot;/tags/2437&quot; [8] &quot;/tags/283&quot; Теперь и all_meta, и all_meta_links — это список (объект типа list). В данном случае внутрюняя структуру списка не очень сложная, но она нам важна (ведь в одном фанфике может быть несколько пэйрингов). Так что сначала создадим вектор, в котором запишем, сколько элементов попалось в каждом из фанфиков. map_dbl(all_meta, length) [1] 29 38 8 12 30 7 28 17 33 11 31 10 12 12 44 12 6 9 26 10 18 15 11 9 14 [26] 14 8 13 11 12 17 12 14 9 7 22 8 12 18 7 26 13 17 22 14 12 27 10 8 19 Теперь мы можем создать вектор с повторяющимеся значениями и вставить его как индекс: tibble(meta = unlist(all_meta), links = unlist(all_meta_links), name = rep(pop_fan_fiction$value, map_dbl(all_meta, length))) Мы получили нужный датасет, теперь давайте отфильтруем и соединим: tibble(meta = unlist(all_meta), links = unlist(all_meta_links), value = rep(pop_fan_fiction$value, map_dbl(all_meta, length))) %&gt;% filter(str_detect(links, &quot;pairings&quot;)) %&gt;% select(-links) %&gt;% group_by(value) %&gt;% summarise(pairing = str_c(meta, collapse = &quot; | &quot;)) %&gt;% full_join(pop_fan_fiction) 4.4 Обкачивание нескольких страниц До сих пор мы обкачивали только одну страницу, но представим себе, что нам нужно обкачать много однотипных страниц. В нашем случае это могут быть разные разделы популярных фанфиков: В данном случае все эти ссылки уже есть на странице, так что мы можем их скачать: source %&gt;% html_nodes(&quot;a&quot;) %&gt;% html_attr(&quot;href&quot;) %&gt;% str_subset(&quot;popular/&quot;) -&gt; links_to_scrap Теперь давайте подоготовим функцию для обкачивания: my_scrap &lt;- function(x){ print(x) source &lt;- read_html(str_c(&quot;https://ficbook.net&quot;, x)) source %&gt;% html_nodes(&quot;h3 a&quot;) %&gt;% html_text() -&gt; titles source %&gt;% html_nodes(&quot;h3 a&quot;) %&gt;% html_attr(&quot;href&quot;) -&gt; links tibble(titles, links) } А теперь мы готовы соединить все вместе: result &lt;- map_dfr(links_to_scrap, my_scrap) [1] &quot;/popular/gen&quot; [1] &quot;/popular/het&quot; [1] &quot;/popular/slash&quot; [1] &quot;/popular/femslash&quot; [1] &quot;/popular/article&quot; [1] &quot;/popular/mixed&quot; [1] &quot;/popular/other&quot; result Часто генерация ссылок для скачивания достаточно проста, например, чтобы скачать все фанфики, посвященные “Очень старнным делам,” нужно будет обкачать 172 страницы, и, хотя на первой странице не указано ссылки, как появляется так много страниц становится понятно на второй странице: str_c(&quot;https://ficbook.net/fanfiction/movies_and_tv_series/ochenj_strannie_dela?p=&quot;, 1:172, &quot;.html&quot;) %&gt;% head() [1] &quot;https://ficbook.net/fanfiction/movies_and_tv_series/ochenj_strannie_dela?p=1.html&quot; [2] &quot;https://ficbook.net/fanfiction/movies_and_tv_series/ochenj_strannie_dela?p=2.html&quot; [3] &quot;https://ficbook.net/fanfiction/movies_and_tv_series/ochenj_strannie_dela?p=3.html&quot; [4] &quot;https://ficbook.net/fanfiction/movies_and_tv_series/ochenj_strannie_dela?p=4.html&quot; [5] &quot;https://ficbook.net/fanfiction/movies_and_tv_series/ochenj_strannie_dela?p=5.html&quot; [6] &quot;https://ficbook.net/fanfiction/movies_and_tv_series/ochenj_strannie_dela?p=6.html&quot; 4.4.1 Некоторые советы Некоторые ресурсы блокируют возможность скачивать из них данные. Обычно это делается на уровне сервера, который видит, что с какого-то IP приходит по 5 запросов в секунду и ограничивает доступ, на случай если вы начинаете DDoS атаку. Если сервер не отдает вам данные или отдает, но раз в какой-то временной промежуток, следует прописать в вашей программе ожидание (команда Sys.sleep()). Некоторые сайты, например, Википедия, специально архивирует данные, чтобы люди не пытались ее обкачать: вот страница, на которой это подробно описано. Обкачайте первые 10 страниц с фанфиками вашего фандома и сделайте следующую таблицу. Это проще звучит, чем оно на самом деле, я всячески рекоммендую составить алгоритм. Это задание, которое принесет удовлетворение тем, кто слезами и потом его победит. Так что спрашивайте советов. "]]
